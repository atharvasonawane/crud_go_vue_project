package handlers

import (
	"first_project/config"
	"first_project/models"
	"fmt"
	"net/http"
	"time"

	"github.com/jung-kurt/gofpdf"
)

// Map to display state name instead of their id's
var stateMap = map[string]string{
	"1": "Maharashtra",
	"2": "Karnataka",
}

var districtMap = map[string]string{
	"1": "Pune",
	"2": "Nagpur",
	"3": "Bengaluru Urban",
	"4": "Mysuru",
}

var talukaMap = map[string]string{
	"1": "Haveli",
	"2": "Shirur",
	"3": "Hingna",
	"4": "Umred",
	"5": "Bengaluru North",
	"6": "Bengaluru South",
	"7": "Mysuru Taluka",
	"8": "Nanjangud",
}

func pdfHeader(pdf *gofpdf.Fpdf) {

	pdf.Image("assets/logo.png", 20, 15, 35, 0, false, "", 0, "")

	pdf.SetY(12)

	pdf.SetFont("Arial", "B", 16)
	pdf.CellFormat(0, 8, "K.K.Wagh Institute of Engineering Education And Research", "", 1, "C", false, 0, "")

	pdf.SetFont("Arial", "", 11)
	pdf.CellFormat(0, 6, "Address: Pune, Maharashtra", "", 1, "C", false, 0, "")
	pdf.CellFormat(0, 6, "Phone: 9876543210 | Email: info@abccollege.edu", "", 1, "C", false, 0, "")

	pdf.Ln(4)

	y := pdf.GetY()
	pdf.Line(10, y, 287, y)

	pdf.Ln(6)
}

func pdfFooter(pdf *gofpdf.Fpdf, username string) {
	pdf.SetY(-20)

	// Line above footer
	pdf.Line(10, pdf.GetY(), 287, pdf.GetY())

	pdf.Ln(5)

	// Footer text
	pdf.SetFont("Arial", "", 9)

	currentTime := time.Now().Format("02 Jan 2006 15:04")
	leftText := "Generated by: " + username + " | " + currentTime
	rightText := "Page " + fmt.Sprintf("%d", pdf.PageNo())

	// Left side
	pdf.CellFormat(0, 6, leftText, "", 0, "L", false, 0, "")

	// Right side
	pdf.CellFormat(0, 6, rightText, "", 0, "R", false, 0, "")
}

func DownloadStudentsPDF(w http.ResponseWriter, r *http.Request) {

	rows, err := config.DB.Query(`
SELECT id, student_name, address, state, district, taluka,
       email, mobile_number, blood_group
FROM students
	`)

	if err != nil {
		http.Error(w, "Failed to fetch students", http.StatusInternalServerError)
		return
	}
	defer rows.Close()

	var students []models.Student

	for rows.Next() {
		var s models.Student
		rows.Scan(
			&s.ID,
			&s.StudentName,
			&s.Address,
			&s.State,
			&s.District,
			&s.Taluka,
			&s.Email,
			&s.MobileNumber,
			&s.BloodGroup,
		)
		students = append(students, s)
	}

	pdf := gofpdf.New("L", "mm", "A4", "")

	pdf.SetAutoPageBreak(true, 25)

	username := "Admin"

	pdf.SetHeaderFunc(func() {
		pdfHeader(pdf)
	})

	pdf.SetFooterFunc(func() {
		pdfFooter(pdf, username)
	})

	pdf.AddPage()
	pdf.Ln(5)
	pdf.SetFont("Arial", "B", 12)
	pdf.CellFormat(0, 10, "Student List", "", 1, "C", false, 0, "")
	pdf.Ln(3)

	colWidths := []float64{
		12, // ID
		35, // Name
		55, // Address
		22, // State
		28, // District
		28, // Taluka
		55, // Email
		30, // Mobile
		15, // Blood
	}
	pdf.SetFont("Arial", "B", 10)

	headers := []string{
		"ID",
		"Name",
		"Address",
		"State",
		"District",
		"Taluka",
		"Email",
		"Mobile",
		"Blood",
	}

	for i, h := range headers {
		pdf.CellFormat(colWidths[i], 8, h, "1", 0, "C", false, 0, "")
	}
	pdf.Ln(-1)

	pdf.SetFont("Arial", "", 10)

	for _, s := range students {

		pdf.CellFormat(colWidths[0], 8, fmt.Sprintf("%d", s.ID), "1", 0, "C", false, 0, "")
		pdf.CellFormat(colWidths[1], 8, s.StudentName, "1", 0, "L", false, 0, "")
		pdf.CellFormat(colWidths[2], 8, s.Address, "1", 0, "L", false, 0, "")
		pdf.CellFormat(colWidths[3], 8, stateMap[s.State], "1", 0, "L", false, 0, "")
		pdf.CellFormat(colWidths[4], 8, districtMap[s.District], "1", 0, "L", false, 0, "")
		pdf.CellFormat(colWidths[5], 8, talukaMap[s.Taluka], "1", 0, "L", false, 0, "")

		pdf.CellFormat(colWidths[6], 8, s.Email, "1", 0, "L", false, 0, "")
		pdf.CellFormat(colWidths[7], 8, s.MobileNumber, "1", 0, "L", false, 0, "")
		pdf.CellFormat(colWidths[8], 8, s.BloodGroup, "1", 0, "C", false, 0, "")

		pdf.Ln(-1)

	}

	w.Header().Set("Content-Type", "application/pdf")
	w.Header().Set("Content-Disposition", "attachment; filename=students.pdf")

	err = pdf.Output(w)
	if err != nil {
		http.Error(w, "Failed to generate PDF", http.StatusInternalServerError)
		return
	}
}
